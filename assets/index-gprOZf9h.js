(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const i=t=>{const e=document.createElement(t.tag);return t.classNames.forEach(n=>e.classList.add(n)),t.textContent&&(e.textContent=t.textContent),t.callback&&e.addEventListener("click",t.callback),e instanceof HTMLAnchorElement&&t.href&&(e.href=t.href),e},y=(t,e,n)=>{const o=document.createElementNS("http://www.w3.org/2000/svg","svg");t.forEach(a=>o.classList.add(a));const s=document.createElementNS("http://www.w3.org/2000/svg","use");return o.append(s),n&&o.setAttribute("fill",n),s.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",`icons/sprite.svg#${e}`),o},c=(t,e=document)=>{const n=e.querySelector(t);if(!n)throw new Error(`Element with selector "${t}" not found`);return n},Q="https://github.com/kevaniy0",Z={tag:"footer",classNames:["footer"]},tt={tag:"a",classNames:["footer-logo"],href:Q},et={tag:"p",classNames:["copyright"],textContent:"©   2024"},nt=()=>{const t=i(Z),e=i(et),n=i(tt);return n.setAttribute("target","_black"),t.append(e,n),t},ot={tag:"header",classNames:["header"]},st={tag:"h1",classNames:["header-title","title"],textContent:"Async Race"},N=(t,e)=>{const n=i(e?{...t,callback:e}:t);return n.setAttribute("type","button"),n},at={tag:"ul",classNames:["list","menu-list"]},rt={tag:"li",classNames:["menu-list__item"]},ct={tag:"li",classNames:["menu-list__item"]},it={tag:"button",classNames:["menu-list__button","button-primary","button-winners"],textContent:"Winners"},lt={tag:"button",classNames:["menu-list__button","button-primary","button-garage"],textContent:"Garage"},I=t=>t.replace(/\D/g,""),$="asyncRaceStateStorage_KEY",ut={garagePage:1,winnersPage:1,inputValues:{create:"",createColor:"",update:"",updateColor:""}},dt=()=>{localStorage.setItem($,JSON.stringify(ut))},w=()=>{const t=localStorage.getItem($);return JSON.parse(t)},A=t=>{if(t==="garage"){const e=c(".input-create").value,n=c(".color-picker__create").value,o=c(".color-picker__update").value,s=c(".input-update").value,a=c(".current-page").textContent,l=I(a),r=w();r.garagePage=Number(l),r.inputValues.create=e,r.inputValues.createColor=n,r.inputValues.updateColor=o,r.inputValues.update=s,localStorage.setItem($,JSON.stringify(r))}else{const e=c(".current-page").textContent,n=I(e),o=w();o.winnersPage=Number(n),localStorage.setItem($,JSON.stringify(o))}},gt=()=>{const t=w(),e=c(".input-create"),n=c(".input-update"),o=c(".color-picker__create"),s=c(".color-picker__update");e.value=t.inputValues.create,o.value=t.inputValues.createColor,n.value=t.inputValues.update,s.value=t.inputValues.updateColor},pt=()=>{const t=i(at),e=i(rt),n=N(lt,()=>{c(".button-winners").removeAttribute("disabled"),n.disabled=!0,A("winners"),k.navigate("/garage")});n.disabled=!0,e.append(n);const o=i(ct),s=N(it,()=>{s.disabled=!0,n.disabled=!1,A("garage"),k.navigate("/winners")});return o.append(s),t.append(e,o),t},mt=()=>{const t=i(ot),e=i(st),n=pt();return t.append(e,n),t},bt={tag:"main",classNames:["main"]},ft=()=>i(bt),ht=()=>{const t=c(".main");for(;t.firstElementChild;)t.firstElementChild.remove()},Ct={tag:"div",classNames:["container"]},wt=t=>({navigate:e=>{const n=t.find(o=>o.path===e);n&&(ht(),n.callback(),window.location.pathname!==e&&(console.log(`/async-race${e}`),window.history.pushState(null,"",`/async-race${e}`)))}}),_="http://127.0.0.1:3000/garage",C=(t=1,e=7)=>{let n=0;const o=`${_}?_page=${t}&_limit=${e}`;return fetch(o).then(s=>{if(!s.ok)throw new Error(`Ошибка HTTP: ${s.status}`);return n=Number(s.headers.get("X-Total-Count")),s.json()}).then(s=>({collection:s,page:t,total:n})).catch(s=>{throw s})},Nt={tag:"div",classNames:["garage-container"]},vt={tag:"h1",classNames:["garage-title","title"],textContent:"Garage"},yt={tag:"h2",classNames:["current-page","title"],textContent:"Page"},_t={tag:"section",classNames:["section-garage"]},Et={tag:"div",classNames:["car-container"]},$t={tag:"p",classNames:["car-name"]},At=["car-image"],Lt=["finish-image"],Pt={tag:"form",classNames:["garage-form"]},Bt={tag:"label",classNames:["label","label-create"]},St={tag:"input",classNames:["input-text","input-create"]},xt={tag:"button",classNames:["button","button-primary","button-create"],textContent:"CREATE"},kt={tag:"label",classNames:["label","label-update"]},Tt={tag:"input",classNames:["input-text","input-update"]},Rt={tag:"button",classNames:["button","button-primary","button-update"],textContent:"UPDATE"},It={tag:"div",classNames:["button-field"]},Ut={tag:"button",classNames:["button","button-primary","button__race"],textContent:"RACE"},Ot={tag:"button",classNames:["button","button-primary","button__reset"],textContent:"RESET"},Wt={tag:"button",classNames:["button","button-primary","generate-cars-button"],textContent:"GENERATE CARS"},Mt={tag:"div",classNames:["action-buttons-container"]},Gt={tag:"button",classNames:["action-button","select-button","button"],textContent:"SELECT"},Vt={tag:"button",classNames:["action-button","delete-button","button"],textContent:"DELETE"},jt={tag:"div",classNames:["pagination-field","pagination-field__garage"]},Ft={tag:"button",classNames:["pagination-button","pagination-button__left","button","button-primary"],textContent:"PREV"},qt={tag:"button",classNames:["pagination-button","pagination-button__right","button","button-primary"],textContent:"NEXT"},F=(t,e="orange")=>fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,color:e})}),T=t=>{const e=`${_}/${t}`;return fetch(e).then(n=>n.json().then(o=>o))},Dt=(t,e,n)=>{const o=`${_}/${t}`;return fetch(o,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,color:n})})},U=t=>{const e=i(t);return e.type="color",e.addEventListener("click",n=>{n.stopPropagation()}),e.addEventListener("input",n=>{const o=n.target;o&&(e.setAttribute("value",o.value),A("garage"))}),e},Ht={tag:"input",classNames:["color-picker","color-picker__create"]},Jt={tag:"input",classNames:["color-picker","color-picker__update"]},O=t=>i(t),R=t=>{const e=c(".garage-title");e.textContent=`Garage (${t})`},Kt=t=>{const e=i(Pt),n=i(Bt);n.onclick=g=>g.preventDefault();const o=O(St),s=U(Ht),a=N(xt);a.addEventListener("click",()=>{const g=o.value;F(g,s.value).then(()=>{const m=w();C(m.garagePage).then(f=>{const h=c(".button__race");h.disabled=!1,v(t,f),R(f.total),o.value="",s.value="black"})})}),n.append(o,s,a);const l=i(kt);l.onclick=g=>g.preventDefault();const r=O(Tt),d=U(Jt),u=N(Rt);return u.disabled=!0,u.addEventListener("click",()=>{const g=r.dataset.carId,m=r.value,f=d.value;T(Number(g)).then(({id:h})=>{Dt(h,m,f).then(()=>{const b=w();return C(b.garagePage)}).then(b=>{v(t,b),r.value="",u.disabled=!0,d.value="black"})})}),l.append(r,d,u),e.append(n,l),e},q="http://127.0.0.1:3000/engine",L=(t,e)=>{const n=`${q}?id=${t.idCar}&status=${t.status}`;return fetch(n,{method:"PATCH",signal:e}).then(o=>{if(o.status===200)return o.json();throw new Error(`${o.status} - ${o.text}`)}).then(o=>o).catch(o=>o.message)},D=(t,e)=>{const n=`${q}?id=${t}&status=drive`;return fetch(n,{method:"PATCH",signal:e}).then(o=>{if(o.status===200&&o.json(),o.status===500)return{success:!1};throw new Error(`${o.status} - ${o.text}`)}).then(o=>o).catch(o=>o.message)},E="http://localhost:3000/winners",Xt=t=>fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),H=()=>{const t=`${E}`;return fetch(t).then(e=>e.json()).then(e=>e)},zt=(t,e)=>{const n=`${E}/${t}`;return fetch(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},Yt=()=>{Array.from(document.body.querySelectorAll(".engine-button__start")).forEach(n=>{n.setAttribute("disabled","true")}),Array.from(document.body.querySelectorAll(".engine-button__stop")).forEach(n=>{n.removeAttribute("disabled")})},Qt=()=>{const t=c(".button__race");t.disabled&&(t.disabled=!1),Array.from(document.body.querySelectorAll(".engine-button__start")).forEach(o=>{o.removeAttribute("disabled")}),Array.from(document.body.querySelectorAll(".engine-button__stop")).forEach(o=>{o.setAttribute("disabled","true")})},Zt={tag:"div",classNames:["modal-wrapper"]},te={tag:"p",classNames:["modal-winner"],textContent:"Winner: "},ee={tag:"p",classNames:["modal-time"],textContent:"Time: "},ne={tag:"button",classNames:["button","button-primary","modal-button"],textContent:"OK"},J=()=>{c(".modal-wrapper").remove(),document.body.removeEventListener("click",J)},oe=(t,e)=>{const n=i(Zt),o=i(te);o.innerHTML=`${o.textContent} <span class="modal-span">${String(t)}</span>`;const s=i(ee);s.innerHTML=`${s.textContent} <span class="modal-span">${String(e)} s</span>`;const a=i(ne);return n.append(o,s,a),document.body.addEventListener("click",J),n},p={},K=(t,e,n)=>{const o=performance.now(),s=parseFloat(window.getComputedStyle(e).left)||0,a=e.parentElement.offsetWidth-s-40;function l(r){const d=e,u=r-o,g=Math.min(u/n,1),m=s+g*(a-s);d.style.left=`${m}px`,g<1?p[t].animationId=requestAnimationFrame(l):p[t].animationId=null}p[t].animationId=requestAnimationFrame(l)},P=t=>{p[t].controller&&(p[t].controller.abort(),p[t].controller=null),p[t].animationId!==null&&(cancelAnimationFrame(p[t].animationId),p[t].animationId=null)},X=()=>{const t=[],e=c(".button-create"),n=c(".button-update"),o=c(".button__race"),s=c(".button__reset"),a=c(".generate-cars-button"),l=c(".button-winners"),r=c(".pagination-button__left"),d=c(".pagination-button__right");return t.push(e,n,o,s,a,l,r,d),t},se=()=>{X().filter(n=>n.disabled!==!0).forEach(n=>{n.setAttribute("disabled","true"),n.classList.add("disabled-during-race")})},W=()=>{X().filter(n=>n.classList.contains("disabled-during-race")).forEach(n=>{n.removeAttribute("disabled"),n.classList.remove("disabled-during-race")})},ae=t=>{const e=t[Math.floor(Math.random()*t.length)],n=e.models[Math.floor(Math.random()*e.models.length)];return`${e.brand} ${n}`},re=()=>`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`,ce=100,ie=t=>fetch("/car-models-data.json").then(e=>e.json()).then(async e=>{const n=[];for(let o=0;o<t;o+=1){const s=ae(e),a=re();n.push(F(s,a))}await Promise.all(n)}),le=()=>{const t=i(It),e=N(Ut),n=N(Ot),o=N(Wt);return e.addEventListener("click",async()=>{const s=w().garagePage,a=(await C(s)).collection,l=Object.values(a),r=[];e.disabled=!0;const d=c(".button__reset");d.disabled=!0,Yt(),se(),l.forEach(u=>{r.push(L({idCar:u.id,status:"started"}).then(async g=>{if(typeof g=="string")throw new Error;const m=c(`#car-${u.id}`),f=g.distance/g.velocity;p[u.id]&&(p[u.id].controller=null),p[u.id].animationId!==null&&cancelAnimationFrame(p[u.id].animationId);const h=new AbortController;p[u.id].controller=h,K(u.id,m,f);const b=await D(u.id,h.signal);if(typeof b!="string"&&b.success===!1)throw P(u.id),new Error;return{...u,time:Number((f/1e3).toFixed(2))}}))}),Promise.any([...r]).then(async u=>{const g=oe(u.name,u.time);c(".main").append(g),d.disabled=!1;const h=(await H()).find(b=>b.id===u.id);if(W(),h){const b=h.time,B=b>u.time?u.time:b;zt(u.id,{wins:h.wins+1,time:B})}else Xt({id:u.id,wins:1,time:u.time})}).catch(()=>{console.log("There is NO winner, all cars broke down"),W(),d.disabled=!1})}),o.addEventListener("click",()=>{ie(ce).then(()=>C()).then(s=>{const a=c(".section-garage");v(a,s);const l=c(".button__race");l.disabled=!1})}),n.addEventListener("click",async()=>{const s=w().garagePage,a=(await C(s)).collection,r=Object.values(a).map(async d=>{P(d.id),await L({idCar:d.id,status:"stopped"});const u=c(`#car-${d.id}`);u.style.left="60px"});await Promise.all(r),Qt()}),t.append(e,n,o),t},ue=t=>{const e=`${_}/${t}`;return fetch(e,{method:"DELETE"})},de=async t=>{const e=`${E}/${t}`;try{await fetch(e,{method:"DELETE"})}catch{console.log("Данная машина не была победителем")}},ge=(t,e)=>{const n=i(Mt),o=N(Gt);o.addEventListener("click",()=>{const a=c(".input-update"),l=c(".button-update");l.disabled=!1,a.focus(),T(e).then(r=>{const d=c(".color-picker__update");d.value=r.color,a.value=r.name}),a.dataset.carId=String(e)});const s=N(Vt);return s.addEventListener("click",()=>{ue(e).then(()=>{const a=w();return C(a.garagePage)}).then(a=>{if(a.collection.length===0&&a.page===1){const l=c(".button__race");return l.disabled=!0,C()}return a.collection.length===0?C(a.page-1):a}).then(a=>{R(a.total),v(t,a),H().then(l=>{l.find(d=>d.id===e)&&de(e)})})}),n.append(o,s),n},pe={tag:"div",classNames:["winners-container"]},me={tag:"h1",classNames:["winners-title","title"],textContent:"Winners"},be={tag:"h2",classNames:["current-page","title"],textContent:"Page"},fe={tag:"table",classNames:["winners-list"]},he={tag:"div",classNames:["pagination-field","pagination-field__garage"]},Ce={tag:"button",classNames:["pagination-button","pagination-button__left","button","button-primary"],textContent:"PREV"},we={tag:"button",classNames:["pagination-button","pagination-button__right","button","button-primary"],textContent:"NEXT"},S=(t=1,e=10)=>{const n=`${E}?_page=${t}&_limit=${e}`;let o=0;return fetch(n).then(s=>(o=Number(s.headers.get("X-Total-Count")),s.json())).then(s=>({data:s,page:t,total:o}))},Ne=(t,e,n)=>{n.page===1?(t.setAttribute("data-page","none"),t.setAttribute("disabled","true")):(t.setAttribute("data-page",`${n.page-1}`),t.removeAttribute("disabled")),n.page===Math.ceil(n.total/10)||n.total===0?(e.setAttribute("data-page","none"),e.setAttribute("disabled","true")):(e.setAttribute("data-page",`${n.page+1}`),e.removeAttribute("disabled"))};let x=!0;const M=t=>{const e=c(".winners-list"),n=Array.from(e.rows).slice(1),o=t==="wins"?3:4;n.sort((s,a)=>{const l=Number(s.cells[o].innerText),r=Number(a.cells[o].innerText),d=l-r;return x?d:-d}),n.forEach(s=>{e.tBodies[0].appendChild(s)}),x=!x},G=t=>{const e=c(".sort-wins"),n=c(".sort-time");t.classList.contains("sort-down")?(e.classList.remove("sort-down"),n.classList.remove("sort-down"),t.classList.add("sort-up"),t.classList.remove("sort-down")):t.classList.contains("sort-up")?(e.classList.remove("sort-up"),n.classList.remove("sort-up"),t.classList.add("sort-down"),t.classList.remove("sort-up")):(e.classList.remove("sort-up"),n.classList.remove("sort-up"),e.classList.remove("sort-down"),n.classList.remove("sort-down"),t.classList.add("sort-down"))},ve=t=>{const e=i({tag:"thead",classNames:["thead"]}),n=i({tag:"tr",classNames:["head-row"]});t.headerRow.forEach(l=>{const r=i({tag:"th",classNames:["head-th"],textContent:l});n.append(r),r.textContent==="Wins"&&(r.style.cursor="pointer",r.classList.add("sort-item","sort-wins"),r.addEventListener("click",()=>{M("wins"),G(r)})),r.textContent==="Best Time (seconds)"&&(r.style.cursor="pointer",r.classList.add("sort-item","sort-time"),r.addEventListener("click",()=>{M("time"),G(r)}))});const o=i({tag:"tbody",classNames:["tbody"]});t.data.data.forEach((l,r)=>{const d=i({tag:"tr",classNames:["body-row"]}),u=i({tag:"td",classNames:["td-N"],textContent:`${String(r+1)}`}),g=i({tag:"td",classNames:["td-car"]}),m=i({tag:"td",classNames:["td-name"]});T(l.id).then(b=>{m.textContent=b.name;const B=y(["table-th-svg"],"auto",b.color);g.append(B)});const f=i({tag:"td",classNames:["td-wins"],textContent:`${String(l.wins)}`}),h=i({tag:"td",classNames:["td-time"],textContent:`${String(l.time)}`});d.append(u,g,m,f,h),o.append(d)});const s=c(".pagination-button__left"),a=c(".pagination-button__right");Ne(s,a,t.data),e.append(n),t.table.append(e,o)},z=t=>{var u;const e=c(".main");for(;e.firstElementChild;)(u=e.firstChild)==null||u.remove();const n=i(pe),o=i(me),s=i(be),a=i(fe),l=w(),r=t||l.winnersPage;S(r,10).then(g=>g.data.length===0&&g.page===1?S(1,10):g.data.length===0?S(g.page-1,10):g).then(g=>{ve({table:a,headerRow:["Number","Car","Name","Wins","Best Time (seconds)"],data:g}),o.textContent=`Winners (${g.total})`,s.textContent=`Page # ${g.page}`});const d=Y(he,Ce,we,"winners");n.append(o,s,a,d),e.append(n)},V=(t,e)=>{if(e==="garage"){const n=c(".button__race");n.disabled&&(n.disabled=!1),C(t).then(o=>{const s=c(".section-garage");v(s,o),A("garage")})}else z(t)},Y=(t,e,n,o)=>{const s=i(t),a=i(e),l=i(n);return l.addEventListener("click",()=>{const r=Number(l.getAttribute("data-page"));V(r,o)}),a.addEventListener("click",()=>{const r=Number(a.getAttribute("data-page"));V(r,o)}),s.append(a,l),s},ye=(t,e,n)=>{n.page===1?(t.setAttribute("data-page","none"),t.setAttribute("disabled","true")):(t.setAttribute("data-page",`${n.page-1}`),t.removeAttribute("disabled")),n.page===Math.ceil(n.total/7)||n.total===0?(e.setAttribute("data-page","none"),e.setAttribute("disabled","true")):(e.setAttribute("data-page",`${n.page+1}`),e.removeAttribute("disabled"))},_e=t=>{const e=c(".current-page");e.textContent=`Page #(${t})`},Ee={tag:"div",classNames:["engine-buttons-wrapper"]},$e={tag:"button",classNames:["button","engine-button","engine-button__start"]},Ae={tag:"button",classNames:["button","engine-button","engine-button__stop"]},Le=t=>{const e=i(Ee),n=i($e),o=y(["svg-start","engine-svg"],"start-button");n.append(o);const s=i(Ae);s.disabled=!0;const a=y(["svg-stop","engine-svg"],"stop-button");s.append(a),t in p||(p[t]={controller:null,animationId:null}),e.append(n,s);const l=n.parentElement;return n.addEventListener("click",()=>{L({idCar:t,status:"started"}).then(async r=>{if(typeof r=="string")return;n.disabled=!0;const d=c(".engine-button__stop",l);d.disabled=!1;const u=r.distance/r.velocity,g=c(`#car-${t}`);p[t].controller&&(p[t].controller=null),p[t].animationId!==null&&cancelAnimationFrame(p[t].animationId);const m=new AbortController;p[t].controller=m,K(t,g,u);const f=await D(t,m.signal);typeof f!="string"&&f.success===!1&&P(t)})}),s.addEventListener("click",()=>{P(t),L({idCar:t,status:"stopped"}).then(()=>{const r=c(".engine-button__start",l);r.disabled=!1,s.disabled=!0;const d=c(`#car-${t}`);d.style.left="60px"})}),e},v=(t,e)=>{for(;t.firstElementChild;)t.firstElementChild.remove();e.collection.forEach(s=>{const a=i(Et),l=i($t),r=ge(t,s.id),d=y(At,"auto",s.color);d.id=`car-${s.id}`;const u=y(Lt,"finish","white"),g=Le(s.id);gt(),l.textContent=s.name,a.append(l,r,d,u,g),t.append(a)}),_e(e.page),R(e.total);const n=c(".pagination-button__left"),o=c(".pagination-button__right");ye(n,o,e)},Pe=()=>{const t=c(".main");for(;t.firstElementChild;)t.firstElementChild.remove();const e=i(Nt),n=i(vt),o=i(yt),s=i(_t),a=Kt(s),l=le(),r=w();C(r.garagePage).then(u=>{o.textContent=`Page # ${u.page}`,n.textContent=`Garage (${u.total})`;const g=c(".button__race");u.total===0?g.disabled=!0:g.disabled=!1,v(s,u)});const d=Y(jt,Ft,qt,"garage");e.append(a,l,n,o,s,d),t.append(e)},j={GARAGE:"/garage",WINNERS:"/winners"},Be=[{path:j.GARAGE,callback:Pe},{path:j.WINNERS,callback:z}],k=wt(Be),Se=()=>{dt();const t=i(Ct),e=mt(),n=ft(),o=nt();t.append(e,n,o),document.body.append(t),k.navigate("/garage")};Se();
